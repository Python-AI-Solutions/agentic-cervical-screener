name: Build and Push to GCP Artifact Registry

on:
  push:
    branches: [ main, master, automatic-build-push ]
    tags: [ 'v*' ]
  workflow_dispatch: # Allow manual trigger

env:
  GCP_PROJECT_ID: midyear-pattern-470017-b8
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: docker-builds
  IMAGE_NAME: agentic-cervical-screener

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for GCP Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

    - name: Build and push Docker image
      run: |
        # Generate image tag
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
        elif [[ "${{ github.ref }}" == refs/heads/main ]] || [[ "${{ github.ref }}" == refs/heads/master ]]; then
          TAG=latest
        else
          TAG=${GITHUB_SHA::8}
        fi

        IMAGE_URI="us-central1-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$IMAGE_NAME:$TAG"

        echo "Building and pushing: $IMAGE_URI"

        # Build and push
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --push \
          --tag $IMAGE_URI \
          .

        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_OUTPUT

    - name: Update deployment with new image
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # Update the deployment file with the new image
        NEW_IMAGE="us-central1-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$IMAGE_NAME:latest"

        # Update deploy.yaml
        sed -i "s|image: us-central1-docker.pkg.dev/midyear-pattern-470017-b8/docker-builds/agentic-cervical-screener:.*|image: $NEW_IMAGE|g" deploy/k8s/deploy.yaml

        # Commit the change
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add deploy/k8s/deploy.yaml
        git commit -m "Update image to latest" || echo "No changes to commit"
        git push
