[project]
name = "agentic-cervical-screener-frontend"
version = "0.1.0"
description = "Frontend for Agentic Cervical Screener with VLM testing support"
authors = ["Python-AI-Solutions"]
channels = ["conda-forge"]
platforms = ["osx-arm64", "osx-64", "linux-64"]

[dependencies]
# Node.js (includes npm)
nodejs = "20.*"

# Python for VLM testing
python = "3.12.*"
torchvision = ">=0.24.0,<0.25"
numpy = "<2.3.0"
pytest = ">=7.0.0"

[target.osx-arm64.pypi-dependencies]
# MLX-VLM plugin - only on Apple Silicon
llm = "*"
llm-mlx-vlm = { path = "external/llm-mlx-vlm", editable = true }
mlx-vlm = ">=0.3.6"  # Use latest version
transformers = ">=4.57.1"
huggingface-hub = ">=0.34.0"
mlx-lm = ">=0.23.0,<0.28"
timm = "*"
instructor = "*"



[target.linux-64.pypi-dependencies]
# Linux fallback uses the base llm CLI
llm = "*"
instructor = "*"

[tasks]
# npm passthrough tasks - expose everything via pixi instead of direct npm usage
install = "npm install"
setup = { cmd = "npm install", depends-on = ["install-vlm-plugin"] }
dev = "npm run dev"
build = "npm run build"
preview = "npm run preview"

# Testing tasks - use pixi wrapper for consistency
test = { cmd = "npm test", env = { LLM_BIN = "llm" } }
test-unit = "npm run test:unit"
test-watch = "npm run test:watch"
test-e2e = "npm run test:e2e"
test-e2e-ci = "npm run test:e2e:ci"
test-e2e-ui = "npm run test:e2e:ui"
test-e2e-debug = "npm run test:e2e:debug"
test-vlm = { cmd = "npm run test:vlm", env = { LLM_BIN = "llm" } }
test-all = { cmd = "npm run test:all", env = { LLM_BIN = "llm" } }

# VLM-specific tasks (use 'llm' available in pixi PATH)
vlm-viewer = { cmd = "python scripts/vlm_viewer_audit.py", env = { LLM_BIN = "llm" } }
vlm-test-quick = "python -m mlx_vlm.generate --model mlx-community/pixtral-12b-4bit --max-tokens 50 --temp 0.0 --image $IMAGE --prompt \"$PROMPT\""

# Model management tasks
add-model = "bash scripts/add-vlm-model.sh $MODEL_NAME $HF_PATH"
download-model = "python -m mlx_vlm.download --model $HF_PATH"
test-model = "llm -m $MODEL_NAME 'What do you see?' -a playwright-artifacts/viewer/viewer-desktop-viewer-context.png"

# Setup helpers
install-vlm-plugin = "echo 'VLM plugin installed via pypi-dependencies'"

# Playwright browser installation
install-browsers = "npx playwright install chromium"

# Direct llm command (for testing)
llm-test = "llm -m SmolVLM-500M 'test'"
